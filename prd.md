# 📒 Chrome 扩展产品需求文档（PRD）· Content Customizer

## 🎯 1. 产品概述与目标

| 字段 | 说明 |
| --- | --- |
| **产品名称** | Content Customizer |
| **产品类型** | Chrome 扩展（Manifest V3） |
| **核心目标** | 让用户为任意 URL 定义文本 / 图片 / 属性 / 样式等替换规则，在浏览时实时重写页面内容，获得一致的定制化体验 |
| **目标用户** | 需要个性化网页、进行本地演示或调试的产品经理、运营、开发者 |
| **适配规范** | Chrome Manifest V3 |

---

## 🧩 2. 核心功能与场景

### 2.1 规则管理（Options 页）

| ID | 功能 | 用户需求 | 优先级 |
| --- | --- | --- | --- |
| F01 | 规则列表 | 可以收起/展开查看规则明细，支持快速启停、查看匹配模式 | ✅ 必须 |
| F02 | 创建 / 编辑规则 | 通过"新建规则"或弹出层进入详情，配置 URL 匹配、文本/图片替换、运行模式 | ✅ 必须 |
| F03 | 导入 / 导出 | 以 JSON 备份与迁移规则 | ✅ 高 |
| F04 | 规则折叠面板 | 默认收起详情，只有点击"查看/编辑""新建规则"才展开，保存/取消后自动收起 | ✅ 必须 |
| F05 | 首屏处理模式 | 规则可配置"隐藏原内容/仅预编译/关闭"三种策略，默认隐藏以防止闪烁 | ✅ 必须 |
| F13 | 数据同步 | 支持在不同设备间同步规则设置 | ✅ 必须 |

### 2.2 内容替换定义

| ID | 功能 | 用户需求 | 优先级 |
| --- | --- | --- | --- |
| F06 | 文本替换（含属性） | 支持普通匹配、正则、大小写控制；默认同步替换 placeholder/title/aria/value/textContent 等展示属性 | ✅ 必须 |
| F07 | 图片替换（`img`） | 通过 URL / 正则匹配 `img` 的 `src/srcset` | ✅ 必须 |
| F08 | 背景图替换 | 匹配 `style="background(-image):url(...)"` 及行内样式，替换背景图地址 | ✅ 必须 |
| F09 | 规则统计 | 文本/图片替换条数实时显示，方便管理 | 🚀 增强 |

### 2.3 Popup 交互

| ID | 功能 | 用户需求 | 优先级 |
| --- | --- | --- | --- |
| F10 | 当前页面状态 | 一键查看当前 URL 命中的规则与启用数量 | ✅ 必须 |
| F11 | 快速开关 | 可逐条启停规则，也能"全部启用/全部禁用"当前页规则 | ✅ 必须 |
| F12 | 快速创建入口 | 直接跳转 Options，并预填当前 URL 创建新规则 | ✅ 必须 |

---

## ⚙️ 3. 技术实现与性能策略

### 3.1 架构

| 组件 | 职责 | 说明 |
| --- | --- | --- |
| Background Service Worker | 规则 CRUD、存储、消息分发 | 使用 `chrome.storage.local/sync` + runtime messaging |
| Options Page | 规则管理 UI | 折叠详情 + 表单配置 |
| Popup | 规则状态概览 | 显示当前页匹配结果、快速开关 |
| Content Script | 页面重写 | document_start 注入，负责文本/图片/属性/背景替换 |

### 3.2 性能 & 体验

| 策略 | 目的 | 细节 |
| --- | --- | --- |
| **首屏隐藏** | 防止"原文闪现" | 命中规则且模式为"隐藏"时，在 `document_start` 给 `body` 加 `cc-hidden`，完成初次替换后立即移除（300ms 兜底）；默认启用以优化用户体验 |
| **规则预编译缓存** | 降低匹配开销 | 在 content script 内缓存 `RegExp`，避免重复构造，后续可扩展存入 `chrome.storage.session` |
| **批量替换** | 减少 reflow | `TreeWalker` 扫描文本，只在 `requestAnimationFrame` 中写 DOM；MutationObserver 100ms 去抖 |
| **属性/背景覆盖** | 覆盖更多展示元素 | placeholder/title/aria/value/textContent 默认替换；解析 inline `style.background(-image)` 并替换 url |
| **恢复机制** | 保持稳定性 | 使用 `WeakMap` 记录原值，规则禁用或变更时可回滚文本/属性/图片/样式 |
| **数据同步** | 跨设备一致性 | 支持 `chrome.storage.sync` 存储规则，保持用户在不同设备上的设置一致 |

---

## 🧪 4. 测试 & 验收要点

1. 文本替换应在正文、按钮、链接、placeholder、title、aria 属性等处同步生效。
2. 图片替换同时适用于 `<img>` 与行内 `background-image`，并能恢复原值。
3. Popup 与 Options 的启停状态保持一致，保存后应自动折叠详情。
4. 首屏隐藏策略不应造成页面长期空白（300ms 兜底必须生效），默认启用隐藏模式。
5. 规则导入导出保持兼容，包含 `preloadMode`、替换条目等最新字段。
6. MutationObserver 可处理异步加载内容，不会造成性能瓶颈（检查控制台无报错）。
7. 数据同步功能能够在不同设备间正确同步规则设置。

---

## 📅 5. 迭代与扩展方向

1. **CSS 选择器限定**：允许为文本/属性替换指定 DOM 选择器，进一步精准控制。
2. **外部样式覆盖**：针对 class/ID 的背景图，从外链 CSS 注入覆盖规则。
3. **规则分组/排序**：增加标签与排序，方便管理大量规则。
4. **多浏览器支持**：评估兼容 Edge / Firefox MV3。
5. **团队协作**：提供云端同步或分享链接，团队共享替换策略。

> 本 PRD 随项目迭代实时更新，若有新增能力或限制，请同步完善。